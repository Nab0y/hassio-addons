name: Builder

env:
  DEFAULT_PYTHON: "3.11"

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  information:
    name: Gather add-on information
    runs-on: ubuntu-latest
    outputs:
      changed_addons: ${{ steps.changed_addons.outputs.addons }}
      changed: ${{ steps.changed_addons.outputs.changed }}
    steps:
      - name: ‚§µÔ∏è Check out code from GitHub
        uses: actions/checkout@v4

      - name: üöÄ Run add-on information action
        id: changed_addons
        uses: home-assistant/actions/helpers/info@master

  build:
    name: Build ${{ matrix.addon }} add-on
    runs-on: ubuntu-latest
    needs: information
    if: needs.information.outputs.changed == 'true'
    strategy:
      matrix:
        addon: ${{ fromJson(needs.information.outputs.changed_addons) }}
        arch: ["aarch64", "amd64"]
    steps:
      - name: ‚§µÔ∏è Check out code from GitHub
        uses: actions/checkout@v4

      - name: üèó Set up QEMU
        uses: docker/setup-qemu-action@v3.0.0

      - name: üèó Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.0.0

      - name: ‚ÑπÔ∏è Compose build flags
        id: flags
        run: |
          echo "::set-output name=date::$(date +"%Y-%m-%dT%H:%M:%SZ")"
          from=$(yq --no-colors eval ".build_from.${{ matrix.arch }}" "${{ matrix.addon }}/build.yaml")
          echo "::set-output name=from::${from}"

          if [[ "${{ matrix.arch }}" = "amd64" ]]; then
            echo "::set-output name=platform::linux/amd64"
          elif [[ "${{ matrix.arch }}" = "aarch64" ]]; then
            echo "::set-output name=platform::linux/arm64"
          fi

      - name: üöÄ Build
        uses: docker/build-push-action@v5.0.0
        with:
          push: false
          context: ${{ matrix.addon }}
          platforms: ${{ steps.flags.outputs.platform }}
          build-args: |
            BUILD_FROM=${{ steps.flags.outputs.from }}
            BUILD_DATE=${{ steps.flags.outputs.date }}
            BUILD_DESCRIPTION="${{ matrix.addon }} add-on"
            BUILD_NAME="${{ matrix.addon }}"
            BUILD_REF=${GITHUB_SHA}
            BUILD_REPOSITORY=${{ github.repository }}
            BUILD_VERSION=edge